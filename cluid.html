<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نضال القراء - تحدي القراءة اليومية</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif, 'Arial Unicode MS';
            background: linear-gradient(135deg, #6879e3 0%, #754fa7 100%);
            color: white;
            min-height: 100vh;
            line-height: 1.6;
        }

        .navbar {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px 0;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo {
            font-size: 1.8em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            white-space: nowrap;
        }

        .nav-btn:hover, .nav-btn.active {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-title {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ffffff, #f0f0f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .participant-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .participant-card:hover {
            transform: translateX(5px);
            background: rgba(255, 255, 255, 0.15);
        }

        .participant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .participant-name {
            font-size: 1.3em;
            font-weight: bold;
        }

        .participant-rank {
            background: linear-gradient(45deg, #6879e3, #754fa7);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .participant-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.4em;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        .stat-title {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
        }

        .error {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid rgba(220, 53, 69, 0.5);
            color: #ff6b6b;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .update-status {
            position: fixed;
            top: 80px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            backdrop-filter: blur(10px);
            z-index: 999;
            transition: all 0.3s ease;
        }

        .countdown-card {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .countdown-number {
            font-size: 3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .elimination-card {
            background: linear-gradient(135deg, #ff4757 0%, #c44569 100%);
            border: 2px solid #ff3838;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 71, 87, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
        }

        .season-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .season-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .records-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .records-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            color: #ffd700;
        }

        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border-left: 4px solid #ffd700;
        }

        .medal {
            font-size: 1.5em;
            margin-left: 10px;
        }

        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                gap: 15px;
            }

            .nav-buttons {
                justify-content: center;
            }

            .page-title {
                font-size: 2em;
            }

            .participant-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .season-comparison {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- شريط التنقل -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                📚 نضال القراء
            </div>
            <div class="nav-buttons">
                <button class="nav-btn active" onclick="showPage('current-results')">النتائج الحالية</button>
                <button class="nav-btn" onclick="showPage('elimination-countdown')">عدادات الطرد</button>
                <button class="nav-btn" onclick="showPage('elimination-list')">المستحقين للطرد</button>
                <button class="nav-btn" onclick="showPage('season-comparison')">مقارنة المواسم</button>
                <button class="nav-btn" onclick="showPage('records')">الأرقام القياسية</button>
                <button class="nav-btn" onclick="showPage('overall-results')">النتائج الإجمالية</button>
            </div>
        </div>
    </nav>

    <!-- حالة التحديث -->
    <div id="update-status" class="update-status" style="display: none;">
        🔄 جاري تحديث البيانات...
    </div>

    <div class="container">
        <!-- صفحة النتائج الحالية -->
        <div id="current-results" class="page active">
            <h1 class="page-title">📊 النتائج الحالية - الموسم الجاري</h1>
            
            <!-- إحصائيات سريعة -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-participants">0</div>
                    <div class="stat-label">إجمالي المشاركين</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-ideas">0</div>
                    <div class="stat-label">إجمالي الأفكار</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-hours">0</div>
                    <div class="stat-label">إجمالي ساعات القراءة</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="current-season">1</div>
                    <div class="stat-label">الموسم الحالي</div>
                </div>
            </div>

            <!-- الرسم البياني - ترتيب حسب الأفكار -->
            <div class="chart-container">
                <h2 style="text-align: center; margin-bottom: 20px;">🏆 ترتيب المشاركين حسب إجمالي الأفكار</h2>
                <canvas id="ideas-chart" width="400" height="200"></canvas>
            </div>

            <!-- الرسم البياني - ترتيب حسب الاستمرارية -->
            <div class="chart-container">
                <h2 style="text-align: center; margin-bottom: 20px;">🔥 ترتيب المشاركين حسب الأيام المتتالية</h2>
                <canvas id="streak-chart" width="400" height="200"></canvas>
            </div>

            <!-- قائمة المشاركين التفصيلية -->
            <div id="participants-list">
                <div class="loading">📥 جاري تحميل البيانات...</div>
            </div>
        </div>

        <!-- صفحة عدادات الطرد -->
        <div id="elimination-countdown" class="page">
            <h1 class="page-title">⏰ عدادات الطرد</h1>
            <p style="text-align: center; margin-bottom: 30px; font-size: 1.1em; opacity: 0.9;">
                العداد التنازلي للأيام المتبقية قبل الطرد لكل مشارك
            </p>
            <div id="countdown-list">
                <div class="loading">⏳ جاري حساب العدادات...</div>
            </div>
        </div>

        <!-- صفحة المستحقين للطرد -->
        <div id="elimination-list" class="page">
            <h1 class="page-title">🚨 المستحقين للطرد</h1>
            <p style="text-align: center; margin-bottom: 30px; font-size: 1.1em; opacity: 0.9;">
                المشاركين الذين استوفوا شروط الطرد خلال آخر 5 أيام
            </p>
            <div id="elimination-candidates">
                <div class="loading">🔍 جاري فحص شروط الطرد...</div>
            </div>
        </div>

        <!-- صفحة مقارنة المواسم -->
        <div id="season-comparison" class="page">
            <h1 class="page-title">📈 مقارنة المواسم</h1>
            
            <!-- الرسم البياني للمقارنة -->
            <div class="chart-container">
                <h2 style="text-align: center; margin-bottom: 20px;">📊 مقارنة المواسم</h2>
                <canvas id="seasons-chart" width="400" height="200"></canvas>
            </div>

            <!-- إحصائيات المواسم -->
            <div id="seasons-stats" class="season-comparison">
                <div class="loading">📊 جاري حساب إحصائيات المواسم...</div>
            </div>
        </div>

        <!-- صفحة الأرقام القياسية -->
        <div id="records" class="page">
            <h1 class="page-title">🏅 الأرقام القياسية</h1>
            
            <!-- أرقام الموسم الحالي -->
            <div class="records-section">
                <div class="records-title">🌟 أرقام الموسم الحالي</div>
                <div id="current-season-records">
                    <div class="loading">🏆 جاري حساب الأرقام القياسية...</div>
                </div>
            </div>

            <!-- أرقام عبر جميع المواسم -->
            <div class="records-section">
                <div class="records-title">👑 أرقام عبر جميع المواسم</div>
                <div id="all-time-records">
                    <div class="loading">📚 جاري حساب الأرقام التاريخية...</div>
                </div>
            </div>
        </div>

        <!-- صفحة النتائج الإجمالية -->
        <div id="overall-results" class="page">
            <h1 class="page-title">📋 النتائج الإجمالية</h1>
            <p style="text-align: center; margin-bottom: 30px; font-size: 1.1em; opacity: 0.9;">
                النتائج التراكمية لجميع المشاركين عبر جميع المواسم
            </p>

            <!-- الرسم البياني الإجمالي -->
            <div class="chart-container">
                <h2 style="text-align: center; margin-bottom: 20px;">📊 الترتيب الإجمالي حسب الأفكار</h2>
                <canvas id="overall-chart" width="400" height="200"></canvas>
            </div>

            <!-- قائمة النتائج الإجمالية -->
            <div id="overall-participants-list">
                <div class="loading">📊 جاري حساب النتائج الإجمالية...</div>
            </div>
        </div>
    </div>

    <script src="names.js"></script>
    <script>
        // إعدادات API
        const API_CONFIG = {
            key: 'AIzaSyBjycpwQVemlyKbAgbk8dpANkFp_cAUJ-w',
            spreadsheetId: '12_XBxWzv7xk8B-qIokzZfemY8YQTI8yRF9l8AO9fFKc',
            sheetName: 'الحصاد اليومي',
            range: 'الحصاد اليومي!A:D'
        };

        // بيانات التطبيق
        let appData = {
            rawData: [],
            participants: new Map(),
            seasons: [],
            currentSeason: 1,
            lastUpdate: null
        };

        // دالة تحويل التاريخ الميلادي للهجري (مبسطة)
        function gregorianToHijri(date) {
            const g = new Date(date);
            const gYear = g.getFullYear();
            const gMonth = g.getMonth() + 1;
            const gDay = g.getDate();
            
            // تحويل تقريبي - في التطبيق الحقيقي نحتاج مكتبة دقيقة
            const hYear = Math.floor(gYear - 579);
            const hMonth = Math.floor(((gYear - 1970) * 12 + gMonth) % 12) + 1;
            const hDay = gDay;
            
            return { year: hYear, month: hMonth, day: hDay };
        }

        // دالة تحديد الموسم الهجري
        function calculateSeason(date) {
            const hijri = gregorianToHijri(date);
            return hijri.month; // مبسط: كل شهر هجري = موسم
        }

        // دالة تحويل الوقت إلى دقائق
        function timeToMinutes(timeString) {
            if (!timeString || timeString === '0') return 0;
            
            const parts = timeString.split(':');
            const hours = parseInt(parts[0]) || 0;
            const minutes = parseInt(parts[1]) || 0;
            const seconds = parseInt(parts[2]) || 0;
            
            return hours * 60 + minutes + (seconds / 60);
        }

        // دالة حساب الأفكار
        function calculateIdeas(minutes, extraEvents = []) {
            let ideas = 0;
            
            // حساب الأفكار الأساسية
            if (minutes <= 15) {
                ideas = minutes;
            } else if (minutes <= 30) {
                ideas = 15 + (minutes - 15) * 1.15;
            } else {
                ideas = 15 + (15 * 1.15) + (minutes - 30) * 1.2;
            }
            
            // إضافة الأفكار من الفعاليات
            if (extraEvents) {
                extraEvents.split(',').forEach(event => {
                    const trimmedEvent = event.trim();
                    switch(trimmedEvent) {
                        case 'اللقاء الافتتاحي':
                            ideas += 60;
                            break;
                        case 'حضور الجلسة النقاشية':
                            ideas += 60;
                            break;
                        case 'حضور جلسة كتب':
                            ideas += 40;
                            break;
                    }
                });
            }
            
            return Math.round(ideas * 100) / 100;
        }

        // دالة استيراد البيانات من Google Sheets
        async function fetchData() {
            try {
                showUpdateStatus('جاري تحديث البيانات...');
                
                // طريقة بديلة للوصول إلى Google Sheets باستخدام CSV export
                const csvUrl = `https://docs.google.com/spreadsheets/d/${API_CONFIG.spreadsheetId}/export?format=csv&gid=773724470`;
                
                let response;
                try {
                    // محاولة استخدام API أولاً
                    const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${API_CONFIG.spreadsheetId}/values/${API_CONFIG.range}?key=${API_CONFIG.key}`;
                    response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        throw new Error('API failed, trying CSV');
                    }
                    
                    const data = await response.json();
                    if (!data.values || data.values.length < 2) {
                        throw new Error('لا توجد بيانات في الجدول');
                    }
                    
                    appData.rawData = data.values.slice(1);
                    
                } catch (apiError) {
                    console.log('API failed, trying CSV export...');
                    
                    // إذا فشل API، استخدم CSV export
                    response = await fetch(csvUrl);
                    if (!response.ok) {
                        throw new Error(`فشل في الوصول للبيانات: ${response.status}`);
                    }
                    
                    const csvText = await response.text();
                    const rows = parseCSV(csvText);
                    
                    if (rows.length < 2) {
                        throw new Error('لا توجد بيانات في الجدول');
                    }
                    
                    appData.rawData = rows.slice(1);
                }
                
                // إذا لم تنجح أي من الطرق، استخدم بيانات تجريبية
                if (!appData.rawData.length) {
                    console.log('استخدام البيانات التجريبية...');
                    appData.rawData = getSampleData();
                }
                
                processData();
                updateAllPages();
                
                appData.lastUpdate = new Date();
                showUpdateStatus(`آخر تحديث: ${appData.lastUpdate.toLocaleTimeString('ar-SA')}`);
                
                setTimeout(() => hideUpdateStatus(), 3000);
                
            } catch (error) {
                console.error('خطأ في استيراد البيانات:', error);
                
                // استخدم بيانات تجريبية كحل أخير
                console.log('استخدام البيانات التجريبية كحل أخير...');
                appData.rawData = getSampleData();
                processData();
                updateAllPages();
                
                showUpdateStatus('تم تحميل بيانات تجريبية - تحقق من الاتصال', 'error');
                setTimeout(() => hideUpdateStatus(), 5000);
            }
        }

        // دالة تحليل CSV
        function parseCSV(csvText) {
            const rows = [];
            const lines = csvText.split('\n');
            
            for (let line of lines) {
                if (line.trim()) {
                    // تحليل بسيط للـ CSV مع مراعاة الفواصل داخل علامات الاقتباس
                    const row = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            row.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    row.push(current.trim());
                    rows.push(row);
                }
            }
            
            return rows;
        }
        
        // دالة معالجة البيانات
        function processData() {
            appData.participants.clear();
            
            appData.rawData.forEach(row => {
                if (row.length < 3) return;
                
                const timestamp = row[0];
                const email = row[1];
                const timeString = row[2];
                const extraEvents = row[3] || '';
                
                // تحويل التاريخ
                const date = new Date(timestamp);
                const dateKey = date.toDateString();
                const season = calculateSeason(date);
                
                // الحصول على الاسم
                const name = EMAIL_TO_NAME[email] || email.split('@')[0];
                
                // حساب الدقائق والأفكار
                const minutes = timeToMinutes(timeString);
                const ideas = calculateIdeas(minutes, extraEvents);
                
                // إنشاء أو تحديث بيانات المشارك
                if (!appData.participants.has(email)) {
                    appData.participants.set(email, {
                        name: name,
                        email: email,
                        totalIdeas: 0,
                        totalHours: 0,
                        seasonalData: new Map(),
                        readingDays: new Set(),
                        streakData: []
                    });
                }
                
                const participant = appData.participants.get(email);
                
                // تحديث البيانات الإجمالية
                participant.totalIdeas += ideas;
                participant.totalHours += minutes / 60;
                participant.readingDays.add(dateKey);
                
                // تحديث البيانات الموسمية
                if (!participant.seasonalData.has(season)) {
                    participant.seasonalData.set(season, {
                        ideas: 0,
                        hours: 0,
                        days: new Set()
                    });
                }
                
                const seasonData = participant.seasonalData.get(season);
                seasonData.ideas += ideas;
                seasonData.hours += minutes / 60;
                seasonData.days.add(dateKey);
            });
            
            // حساب الاستمرارية
            calculateStreaks();
            
            // تحديد الموسم الحالي
            appData.currentSeason = Math.max(...Array.from(appData.participants.values())
                .flatMap(p => Array.from(p.seasonalData.keys())));
        }

        // دالة حساب الاستمرارية
        function calculateStreaks() {
            appData.participants.forEach(participant => {
                const sortedDates = Array.from(participant.readingDays)
                    .map(dateStr => new Date(dateStr))
                    .sort((a, b) => a - b);
                
                let currentStreak = 0;
                let maxStreak = 0;
                
                for (let i = 0; i < sortedDates.length; i++) {
                    if (i === 0) {
                        currentStreak = 1;
                    } else {
                        const daysDiff = Math.floor((sortedDates[i] - sortedDates[i-1]) / (1000 * 60 * 60 * 24));
                        if (daysDiff === 1) {
                            currentStreak++;
                        } else {
                            currentStreak = 1;
                        }
                    }
                    
                    maxStreak = Math.max(maxStreak, currentStreak);
                }
                
                participant.currentStreak = currentStreak;
                participant.maxStreak = maxStreak;
            });
        }

        // دالة عرض حالة التحديث
        function showUpdateStatus(message, type = 'info') {
            const statusEl = document.getElementById('update-status');
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            
            if (type === 'error') {
                statusEl.style.background = 'rgba(220, 53, 69, 0.9)';
            } else {
                statusEl.style.background = 'rgba(0, 0, 0, 0.8)';
            }
        }

        // دالة إخفاء حالة التحديث
        function hideUpdateStatus() {
            document.getElementById('update-status').style.display = 'none';
        }

        // دالة تحديث جميع الصفحات
        function updateAllPages() {
            updateCurrentResults();
            updateEliminationCountdown();
            updateEliminationList();
            updateSeasonComparison();
            updateRecords();
            updateOverallResults();
        }

        // دالة تحديث صفحة النتائج الحالية
        function updateCurrentResults() {
            const currentSeasonParticipants = Array.from(appData.participants.values())
                .filter(p => p.seasonalData.has(appData.currentSeason))
                .map(p => ({
                    ...p,
                    seasonIdeas: p.seasonalData.get(appData.currentSeason).ideas,
                    seasonHours: p.seasonalData.get(appData.currentSeason).hours,
                    seasonDays: p.seasonalData.get(appData.currentSeason).days.size
                }));
            
            // تحديث الإحصائيات السريعة
            document.getElementById('total-participants').textContent = currentSeasonParticipants.length;
            document.getElementById('total-ideas').textContent = Math.round(currentSeasonParticipants.reduce((sum, p) => sum + p.seasonIdeas, 0));
            document.getElementById('total-hours').textContent = Math.round(currentSeasonParticipants.reduce((sum, p) => sum + p.seasonHours, 0));
            document.getElementById('current-season').textContent = appData.currentSeason;
            
            // ترتيب حسب الأفكار
            const sortedByIdeas = [...currentSeasonParticipants].sort((a, b) => b.seasonIdeas - a.seasonIdeas);
            
            // ترتيب حسب الاستمرارية
            const sortedByStreak = [...currentSeasonParticipants].sort((a, b) => (b.currentStreak || 0) - (a.currentStreak || 0));
            
            // رسم الرسوم البيانية
            createChart('ideas-chart', sortedByIdeas.slice(0, 10), 'seasonIdeas', 'الأفكار');
            createChart('streak-chart', sortedByStreak.slice(0, 10), 'currentStreak', 'الأيام المتتالية');
            
            // عرض قائمة المشاركين
            displayParticipantsList('participants-list', sortedByIdeas);
        }

        // دالة إنشاء الرسوم البيانية
        function createChart(canvasId, data, valueKey, label) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            // تدمير الرسم السابق إن وجد
            if (ctx.chart) {
                ctx.chart.destroy();
            }
            
            ctx.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(p => p.name),
                    datasets: [{
                        label: label,
                        data: data.map(p => p[valueKey] || 0),
                        backgroundColor: 'rgba(104, 121, 227, 0.8)',
                        borderColor: 'rgba(117, 79, 167, 1)',
                        borderWidth: 2,
                        borderRadius: 8,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.2)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.2)'
                            }
                        }
                    }
                }
            });
        }

        // دالة عرض قائمة المشاركين
        function displayParticipantsList(containerId, participants) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            let html = '';
            
            participants.forEach((participant, index) => {
                html += `
                    <div class="participant-card">
                        <div class="participant-header">
                            <div class="participant-name">${participant.name}</div>
                            <div class="participant-rank">#${index + 1}</div>
                        </div>
                        <div class="participant-stats">
                            <div class="stat-item">
                                <span class="stat-value">${Math.round(participant.seasonIdeas || 0)}</span>
                                <span class="stat-title">الأفكار الموسمية</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${Math.round((participant.seasonHours || 0) * 10) / 10}</span>
                                <span class="stat-title">ساعات القراءة</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${participant.currentStreak || 0}</span>
                                <span class="stat-title">الأيام المتتالية</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${participant.seasonDays || 0}</span>
                                <span class="stat-title">أيام القراءة</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<div class="error">لا توجد بيانات للعرض</div>';
        }

        // دالة تحديث عدادات الطرد
        function updateEliminationCountdown() {
            const currentSeasonParticipants = Array.from(appData.participants.values())
                .filter(p => p.seasonalData.has(appData.currentSeason))
                .map(p => {
                    const seasonIdeas = p.seasonalData.get(appData.currentSeason).ideas;
                    const daysLeft = Math.max(0, Math.floor(seasonIdeas / 10));
                    return {
                        ...p,
                        seasonIdeas,
                        daysLeft: Math.min(21, daysLeft)
                    };
                })
                .sort((a, b) => a.daysLeft - b.daysLeft);
            
            const container = document.getElementById('countdown-list');
            let html = '';
            
            currentSeasonParticipants.forEach(participant => {
                const isCloseToElimination = participant.daysLeft <= 5;
                html += `
                    <div class="countdown-card ${isCloseToElimination ? 'elimination-card' : ''}">
                        <div class="participant-name" style="margin-bottom: 15px;">${participant.name}</div>
                        <div class="countdown-number">${participant.daysLeft}</div>
                        <div style="font-size: 1.1em;">يوم متبقي</div>
                        <div style="margin-top: 10px; opacity: 0.8;">
                            الأفكار الحالية: ${Math.round(participant.seasonIdeas)}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<div class="error">لا توجد بيانات للعرض</div>';
        }

        // دالة تحديث قائمة المستحقين للطرد
        function updateEliminationList() {
            const now = new Date();
            const fiveDaysAgo = new Date(now.getTime() - 5 * 24 * 60 * 60 * 1000);
            
            const eliminationCandidates = Array.from(appData.participants.values())
                .filter(p => {
                    if (!p.seasonalData.has(appData.currentSeason)) return false;
                    
                    const seasonData = p.seasonalData.get(appData.currentSeason);
                    const seasonIdeas = seasonData.ideas;
                    
                    // شرط الطرد: الأفكار صفر أو أقل، أو عدم تحقيق 100 فكرة بنهاية الأسبوع الثالث
                    const isEliminated = seasonIdeas <= 0;
                    const lastReadingDate = Math.max(...Array.from(seasonData.days).map(d => new Date(d).getTime()));
                    const daysSinceLastReading = Math.floor((now.getTime() - lastReadingDate) / (1000 * 60 * 60 * 24));
                    
                    return isEliminated && daysSinceLastReading <= 5;
                })
                .map(p => ({
                    ...p,
                    eliminationReason: p.seasonalData.get(appData.currentSeason).ideas <= 0 ? 'وصول الأفكار للصفر' : 'عدم تحقيق الحد الأدنى',
                    eliminationDate: new Date() // تبسيط - في التطبيق الحقيقي نحسب التاريخ الدقيق
                }))
                .sort((a, b) => b.eliminationDate - a.eliminationDate);
            
            const container = document.getElementById('elimination-candidates');
            let html = '';
            
            if (eliminationCandidates.length === 0) {
                html = '<div style="text-align: center; padding: 50px; font-size: 1.2em;">🎉 لا يوجد مستحقين للطرد حالياً!</div>';
            } else {
                eliminationCandidates.forEach(participant => {
                    html += `
                        <div class="participant-card elimination-card">
                            <div class="participant-header">
                                <div class="participant-name">${participant.name}</div>
                                <div style="background: #ff3838; padding: 8px 15px; border-radius: 20px; font-weight: bold;">
                                    مستحق للطرد
                                </div>
                            </div>
                            <div style="margin-top: 15px;">
                                <div><strong>سبب الطرد:</strong> ${participant.eliminationReason}</div>
                                <div><strong>تاريخ الاستحقاق:</strong> ${participant.eliminationDate.toLocaleDateString('ar-SA')}</div>
                                <div><strong>الأفكار الحالية:</strong> ${Math.round(participant.seasonalData.get(appData.currentSeason).ideas)}</div>
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
        }

        // دالة تحديث مقارنة المواسم
        function updateSeasonComparison() {
            const seasons = [...new Set(Array.from(appData.participants.values())
                .flatMap(p => Array.from(p.seasonalData.keys())))].sort((a, b) => a - b);
            
            const seasonStats = seasons.map(season => {
                const seasonParticipants = Array.from(appData.participants.values())
                    .filter(p => p.seasonalData.has(season));
                
                const totalHours = seasonParticipants.reduce((sum, p) => sum + p.seasonalData.get(season).hours, 0);
                const averageHours = seasonParticipants.length > 0 ? totalHours / seasonParticipants.length : 0;
                
                return {
                    season,
                    participantsCount: seasonParticipants.length,
                    averageHours: Math.round(averageHours * 10) / 10,
                    totalHours: Math.round(totalHours),
                    eliminatedCount: 0 // مبسط - في التطبيق الحقيقي نحسب المطرودين
                };
            });
            
            // رسم المقارنة
            const ctx = document.getElementById('seasons-chart');
            if (ctx) {
                if (ctx.chart) ctx.chart.destroy();
                
                ctx.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: seasonStats.map(s => `الموسم ${s.season}`),
                        datasets: [{
                            label: 'عدد المشاركين',
                            data: seasonStats.map(s => s.participantsCount),
                            borderColor: 'rgba(104, 121, 227, 1)',
                            backgroundColor: 'rgba(104, 121, 227, 0.2)',
                            tension: 0.4
                        }, {
                            label: 'متوسط ساعات القراءة',
                            data: seasonStats.map(s => s.averageHours),
                            borderColor: 'rgba(117, 79, 167, 1)',
                            backgroundColor: 'rgba(117, 79, 167, 0.2)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'white'
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: 'white'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.2)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: 'white'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.2)'
                                }
                            }
                        }
                    }
                });
            }
            
            // عرض إحصائيات المواسم
            const container = document.getElementById('seasons-stats');
            let html = '';
            
            seasonStats.forEach(stat => {
                html += `
                    <div class="season-card">
                        <h3>الموسم ${stat.season}</h3>
                        <div style="margin: 15px 0;">
                            <div><strong>${stat.participantsCount}</strong> مشارك</div>
                            <div><strong>${stat.averageHours}</strong> متوسط الساعات</div>
                            <div><strong>${stat.totalHours}</strong> إجمالي الساعات</div>
                            <div><strong>${stat.eliminatedCount}</strong> مطرود</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<div class="error">لا توجد بيانات للعرض</div>';
        }

        // دالة تحديث الأرقام القياسية
        function updateRecords() {
            // أرقام الموسم الحالي
            const currentSeasonParticipants = Array.from(appData.participants.values())
                .filter(p => p.seasonalData.has(appData.currentSeason));
            
            const currentSeasonRecords = calculateRecords(currentSeasonParticipants, true);
            displayRecords('current-season-records', currentSeasonRecords);
            
            // أرقام عبر جميع المواسم
            const allTimeRecords = calculateRecords(Array.from(appData.participants.values()), false);
            displayRecords('all-time-records', allTimeRecords);
        }

        // دالة حساب الأرقام القياسية
        function calculateRecords(participants, seasonOnly) {
            if (participants.length === 0) return {};
            
            // أكثر قراءة في يوم واحد
            const dailyReadings = [];
            participants.forEach(p => {
                if (seasonOnly && p.seasonalData.has(appData.currentSeason)) {
                    // حساب يومي للموسم الحالي (مبسط)
                    const seasonHours = p.seasonalData.get(appData.currentSeason).hours;
                    const seasonDays = p.seasonalData.get(appData.currentSeason).days.size;
                    dailyReadings.push({
                        name: p.name,
                        value: Math.round((seasonHours / Math.max(1, seasonDays)) * 60) // دقائق يومياً
                    });
                } else if (!seasonOnly) {
                    dailyReadings.push({
                        name: p.name,
                        value: Math.round((p.totalHours / Math.max(1, p.readingDays.size)) * 60)
                    });
                }
            });
            
            // أطول استمرارية
            const streakData = participants.map(p => ({
                name: p.name,
                value: seasonOnly ? (p.currentStreak || 0) : (p.maxStreak || 0)
            }));
            
            // أعلى إجمالي أفكار
            const ideasData = participants.map(p => ({
                name: p.name,
                value: seasonOnly ? 
                    Math.round(p.seasonalData.get(appData.currentSeason)?.ideas || 0) : 
                    Math.round(p.totalIdeas)
            }));
            
            return {
                dailyReading: dailyReadings.sort((a, b) => b.value - a.value).slice(0, 3),
                longestStreak: streakData.sort((a, b) => b.value - a.value).slice(0, 3),
                totalIdeas: ideasData.sort((a, b) => b.value - a.value).slice(0, 3)
            };
        }

        // دالة عرض الأرقام القياسية
        function displayRecords(containerId, records) {
            const container = document.getElementById(containerId);
            if (!container || !records.dailyReading) return;
            
            const medals = ['🥇', '🥈', '🥉'];
            
            let html = '';
            
            // أكثر قراءة في يوم واحد
            html += '<h4>📖 أكثر قراءة يومية</h4>';
            records.dailyReading.forEach((record, index) => {
                html += `
                    <div class="record-item">
                        <div>
                            <span class="medal">${medals[index]}</span>
                            ${record.name}
                        </div>
                        <div><strong>${record.value}</strong> دقيقة/يوم</div>
                    </div>
                `;
            });
            
            // أطول استمرارية
            html += '<h4 style="margin-top: 25px;">🔥 أطول استمرارية</h4>';
            records.longestStreak.forEach((record, index) => {
                html += `
                    <div class="record-item">
                        <div>
                            <span class="medal">${medals[index]}</span>
                            ${record.name}
                        </div>
                        <div><strong>${record.value}</strong> يوم</div>
                    </div>
                `;
            });
            
            // أعلى إجمالي أفكار
            html += '<h4 style="margin-top: 25px;">💡 أعلى إجمالي أفكار</h4>';
            records.totalIdeas.forEach((record, index) => {
                html += `
                    <div class="record-item">
                        <div>
                            <span class="medal">${medals[index]}</span>
                            ${record.name}
                        </div>
                        <div><strong>${record.value}</strong> فكرة</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // دالة تحديث النتائج الإجمالية
        function updateOverallResults() {
            const allParticipants = Array.from(appData.participants.values())
                .sort((a, b) => b.totalIdeas - a.totalIdeas);
            
            // رسم الترتيب الإجمالي
            createOverallChart('overall-chart', allParticipants.slice(0, 10));
            
            // عرض قائمة المشاركين الإجمالية
            displayOverallParticipants('overall-participants-list', allParticipants);
        }

        // دالة إنشاء الرسم الإجمالي
        function createOverallChart(canvasId, data) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            if (ctx.chart) {
                ctx.chart.destroy();
            }
            
            ctx.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(p => p.name),
                    datasets: [{
                        label: 'إجمالي الأفكار',
                        data: data.map(p => Math.round(p.totalIdeas)),
                        backgroundColor: 'rgba(104, 121, 227, 0.8)',
                        borderColor: 'rgba(117, 79, 167, 1)',
                        borderWidth: 2,
                        borderRadius: 8,
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.2)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.2)'
                            }
                        }
                    }
                }
            });
        }

        // دالة عرض المشاركين الإجمالي
        function displayOverallParticipants(containerId, participants) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            let html = '';
            
            participants.forEach((participant, index) => {
                const seasonsParticipated = participant.seasonalData.size;
                
                html += `
                    <div class="participant-card">
                        <div class="participant-header">
                            <div class="participant-name">${participant.name}</div>
                            <div class="participant-rank">#${index + 1}</div>
                        </div>
                        <div class="participant-stats">
                            <div class="stat-item">
                                <span class="stat-value">${Math.round(participant.totalIdeas)}</span>
                                <span class="stat-title">إجمالي الأفكار</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${Math.round(participant.totalHours * 10) / 10}</span>
                                <span class="stat-title">إجمالي الساعات</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${participant.maxStreak || 0}</span>
                                <span class="stat-title">أطول استمرارية</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${seasonsParticipated}</span>
                                <span class="stat-title">المواسم المشاركة</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${participant.readingDays.size}</span>
                                <span class="stat-title">أيام القراءة</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${Math.round((participant.totalIdeas / seasonsParticipated) * 10) / 10}</span>
                                <span class="stat-title">متوسط الأفكار/موسم</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<div class="error">لا توجد بيانات للعرض</div>';
        }

        // دالة التنقل بين الصفحات
        function showPage(pageId) {
            // إخفاء جميع الصفحات
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // إزالة الفئة النشطة من جميع الأزرار
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // إظهار الصفحة المطلوبة
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            // تفعيل الزر المطلوب
            event.target.classList.add('active');
        }

        // تهيئة التطبيق عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 تم تحميل تطبيق نضال القراء');
            
            // تحميل البيانات للمرة الأولى
            fetchData();
            
            // تحديث البيانات كل 5 دقائق
            setInterval(fetchData, 5 * 60 * 1000);
            
            // إضافة مستمعي الأحداث للأزرار
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const pageId = this.getAttribute('onclick').match(/'([^']+)'/)[1];
                    showPage(pageId);
                });
            });
        });

        // دوال إضافية للتفاعل
        window.showPage = showPage;
        
        // تشخيص الأخطاء
        window.debugApp = function() {
            console.log('📊 بيانات التطبيق:', appData);
            console.log('👥 المشاركين:', Array.from(appData.participants.entries()));
            console.log('🕐 آخر تحديث:', appData.lastUpdate);
        };
        
        // إعادة تحميل البيانات يدوياً
        window.refreshData = function() {
            fetchData();
        };
    </script>
</body>
</html>