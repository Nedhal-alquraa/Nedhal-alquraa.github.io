<html lang="ar" dir="rtl"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نضال القراء</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@300;400;600;700&display=swap');
        
        :root {
            --primary-gradient: linear-gradient(135deg, #6879e3 0%, #754fa7 100%);
            --primary-color: #6879e3;
            --secondary-color: #754fa7;
            --background: #f8faff;
            --card-bg: white;
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --success: #48bb78;
            --warning: #ed8936;
            --danger: #f56565;
            --border: #e2e8f0;
            --shadow: 0 4px 20px rgba(104, 121, 227, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            direction: rtl;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .header {
            background: var(--primary-gradient);
            color: white;
            padding: 2rem 0;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .header h1 {
            font-family: 'Amiri', serif;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Navigation */
        .nav {
            background: var(--card-bg);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            padding: 1rem 0;
            gap: 0.5rem;
        }

        .nav-btn {
            background: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            padding: 0.7rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .nav-btn:hover, .nav-btn.active {
            background: var(--primary-gradient);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(104, 121, 227, 0.3);
        }

        /* Main Content */
        .main-content {
            padding: 2rem 0;
        }

        .page {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .card h2 {
            font-family: 'Amiri', serif;
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--primary-gradient);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            transform: scale(1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: scale(1.05);
        }

        .stat-card h3 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .stat-card p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
        }

        th, td {
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--primary-gradient);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #f7fafc;
        }

        .rank-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            color: white;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        .rank-1 { background: #ffd700; }
        .rank-2 { background: #c0c0c0; }
        .rank-3 { background: #cd7f32; }
        .rank-other { background: var(--primary-color); }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 400px;
            margin: 2rem 0;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .loading i {
            font-size: 3rem;
            color: var(--primary-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-gradient);
            transition: width 0.3s ease;
        }

        /* Countdown Timer */
        .countdown {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--danger);
            font-weight: 600;
        }

        .countdown.safe {
            color: var(--success);
        }

        .countdown.warning {
            color: var(--warning);
        }

        /* Records Section */
        .records-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .record-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .record-card h3 {
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .record-item:last-child {
            border-bottom: none;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .nav-container {
                padding: 0.5rem;
            }
            
            .nav-btn {
                padding: 0.5rem 1rem;
                font-size: 0.8rem;
            }
            
            .card {
                padding: 1.5rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1rem;
            }
            
            .chart-container {
                height: 300px;
            }
        }

        /* Status Indicators */
        .status-indicator {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-safe {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-warning {
            background: #fef5e7;
            color: #c05621;
        }

        .status-danger {
            background: #fed7d7;
            color: #c53030;
        }
    </style>
<style>
            @media print {
                .nav, .header { display: none !important; }
                .page:not(.active) { display: block !important; }
                .card { break-inside: avoid; margin-bottom: 1rem; }
                .chart-container { height: 300px !important; }
                body { background: white !important; }
            }
        </style></head>
<body>
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-book-open"></i> نضال القراء </h1>
            <p> القراءة اليومية </p>
        </div>
    </div>

    <nav class="nav">
        <div class="container">
            <div class="nav-container">
                <button class="nav-btn active" onclick="showPage('current')" role="tab" tabindex="0">
                    <i class="fas fa-chart-bar"></i> النتائج الحالية
                </button>
                <button class="nav-btn" onclick="showPage('countdown')" role="tab" tabindex="-1">
                    <i class="fas fa-clock"></i> عدادات الطرد
                </button>
                <button class="nav-btn" onclick="showPage('expelled')" role="tab" tabindex="-1">
                    <i class="fas fa-exclamation-triangle"></i> المستحقون للطرد
                </button>
                <button class="nav-btn" onclick="showPage('records')" role="tab" tabindex="-1">
                    <i class="fas fa-trophy"></i> الأرقام القياسية
                </button>
                <button class="nav-btn" onclick="showPage('overall')" role="tab" tabindex="-1">
                    <i class="fas fa-chart-line"></i> النتائج الإجمالية
                </button>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <!-- Current Results Page -->
            <div id="current" class="page active">
                <div class="card">
                    <h2><i class="fas fa-chart-bar"></i> ترتيب المشاركين حسب إجمالي الأفكار</h2>
                    <div class="chart-container">
                        <canvas id="ideasChart" style="box-sizing: border-box; display: block; height: 400px; width: 930.4px;" width="1163" height="500"></canvas>
                    </div>
                </div>
                
                <div class="card">
                    <h2><i class="fas fa-fire"></i> ترتيب المشاركين حسب الأيام المتتالية</h2>
                    <div class="chart-container">
                        <canvas id="streakChart" style="box-sizing: border-box; display: block; height: 400px; width: 930.4px;" width="1163" height="500"></canvas>
                    </div>
                </div>
            </div>

            <!-- Countdown Page -->
            <div id="countdown" class="page">
                <div class="card">
                    <h2><i class="fas fa-clock"></i> عدادات الطرد</h2>
                    <div class="table-container">
                        <table id="countdownTable">
                            <thead>
                                <tr>
                                    <th>الترتيب</th>
                                    <th>اسم المشارك</th>
                                    <th>الأفكار الحالية</th>
                                    <th>الأيام المتبقية</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody id="countdownBody"><tr>
                    <td><span class="rank-badge rank-1">1</span></td>
                    <td>أحمد محمد</td>
                    <td>1562.0</td>
                    <td>
                        <div class="countdown safe">
                            <i class="fas fa-clock"></i>
                            156 يوم
                        </div>
                    </td>
                    <td><span class="status-indicator status-safe">آمن</span></td>
                </tr><tr>
                    <td><span class="rank-badge rank-2">2</span></td>
                    <td>هدى القحطاني</td>
                    <td>1709.9</td>
                    <td>
                        <div class="countdown safe">
                            <i class="fas fa-clock"></i>
                            170 يوم
                        </div>
                    </td>
                    <td><span class="status-indicator status-safe">آمن</span></td>
                </tr><tr>
                    <td><span class="rank-badge rank-3">3</span></td>
                    <td>مريم الشمري</td>
                    <td>1734.1</td>
                    <td>
                        <div class="countdown safe">
                            <i class="fas fa-clock"></i>
                            173 يوم
                        </div>
                    </td>
                    <td><span class="status-indicator status-safe">آمن</span></td>
                </tr><tr>
                    <td><span class="rank-badge rank-other">4</span></td>
                    <td>خالد الصالح</td>
                    <td>1781.2</td>
                    <td>
                        <div class="countdown safe">
                            <i class="fas fa-clock"></i>
                            178 يوم
                        </div>
                    </td>
                    <td><span class="status-indicator status-safe">آمن</span></td>
                </tr><tr>
                    <td><span class="rank-badge rank-other">5</span></td>
                    <td>محمد حسن</td>
                    <td>1803.1</td>
                    <td>
                        <div class="countdown safe">
                            <i class="fas fa-clock"></i>
                            180 يوم
                        </div>
                    </td>
                    <td><span class="status-indicator status-safe">آمن</span></td>
                </tr><tr>
                    <td><span class="rank-badge rank-other">6</span></td>
                    <td>عبدالله الحربي</td>
                    <td>1849.9</td>
                    <td>
                        <div class="countdown safe">
                            <i class="fas fa-clock"></i>
                            184 يوم
                        </div>
                    </td>
                    <td><span class="status-indicator status-safe">آمن</span></td>
                </tr><tr>
                    <td><span class="rank-badge rank-other">7</span></td>
                    <td>عائشة أحمد</td>
                    <td>1873.5</td>
                    <td>
                        <div class="countdown safe">
                            <i class="fas fa-clock"></i>
                            187 يوم
                        </div>
                    </td>
                    <td><span class="status-indicator status-safe">آمن</span></td>
                </tr><tr>
                    <td><span class="rank-badge rank-other">8</span></td>
                    <td>نورا الزهراني</td>
                    <td>1881.7</td>
                    <td>
                        <div class="countdown safe">
                            <i class="fas fa-clock"></i>
                            188 يوم
                        </div>
                    </td>
                    <td><span class="status-indicator status-safe">آمن</span></td>
                </tr><tr>
                    <td><span class="rank-badge rank-other">9</span></td>
                    <td>سعد العتيبي</td>
                    <td>2013.0</td>
                    <td>
                        <div class="countdown safe">
                            <i class="fas fa-clock"></i>
                            201 يوم
                        </div>
                    </td>
                    <td><span class="status-indicator status-safe">آمن</span></td>
                </tr><tr>
                    <td><span class="rank-badge rank-other">10</span></td>
                    <td>فاطمة علي</td>
                    <td>2135.3</td>
                    <td>
                        <div class="countdown safe">
                            <i class="fas fa-clock"></i>
                            213 يوم
                        </div>
                    </td>
                    <td><span class="status-indicator status-safe">آمن</span></td>
                </tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Expelled Page -->
            <div id="expelled" class="page">
                <div class="card">
                    <h2><i class="fas fa-exclamation-triangle"></i> المستحقون للطرد</h2>
                    <div id="expelledContent">
                    <div style="text-align: center; padding: 2rem; color: var(--success);">
                        <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>لا يوجد مشاركون مستحقون للطرد حالياً</h3>
                        <p>جميع المشاركين يحافظون على مستوى جيد من القراءة!</p>
                    </div>
                </div>
                </div>
            </div>

            <!-- Records Page -->
            <div id="records" class="page">
                <div class="card">
                    <h2><i class="fas fa-trophy"></i> الأرقام القياسية - الموسم الحالي</h2>
                    <div class="records-grid" id="recordsGrid">
                <div class="record-card">
                    <h3><i class="fas fa-star"></i> أكثر قراءة في يوم واحد</h3>
                    
                        <div class="record-item">
                            <span><span class="rank-badge rank-1">1</span> نورا الزهراني</span>
                            <span>209.8 فكرة</span>
                        </div>
                    
                        <div class="record-item">
                            <span><span class="rank-badge rank-2">2</span> هدى القحطاني</span>
                            <span>206.3 فكرة</span>
                        </div>
                    
                        <div class="record-item">
                            <span><span class="rank-badge rank-3">3</span> فاطمة علي</span>
                            <span>203.8 فكرة</span>
                        </div>
                    
                </div>
                
                <div class="record-card">
                    <h3><i class="fas fa-fire"></i> أكثر استمرارية</h3>
                    
                        <div class="record-item">
                            <span><span class="rank-badge rank-1">1</span> عبدالله الحربي</span>
                            <span>7 يوم متتالي</span>
                        </div>
                    
                        <div class="record-item">
                            <span><span class="rank-badge rank-2">2</span> فاطمة علي</span>
                            <span>2 يوم متتالي</span>
                        </div>
                    
                        <div class="record-item">
                            <span><span class="rank-badge rank-3">3</span> نورا الزهراني</span>
                            <span>2 يوم متتالي</span>
                        </div>
                    
                </div>
                
                <div class="record-card">
                    <h3><i class="fas fa-trophy"></i> أعلى إجمالي أفكار</h3>
                    
                        <div class="record-item">
                            <span><span class="rank-badge rank-1">1</span> فاطمة علي</span>
                            <span>2135.3 فكرة</span>
                        </div>
                    
                        <div class="record-item">
                            <span><span class="rank-badge rank-2">2</span> سعد العتيبي</span>
                            <span>2013.0 فكرة</span>
                        </div>
                    
                        <div class="record-item">
                            <span><span class="rank-badge rank-3">3</span> نورا الزهراني</span>
                            <span>1881.7 فكرة</span>
                        </div>
                    
                </div>
            </div>
                </div>
            </div>

            <!-- Overall Results Page -->
            <div id="overall" class="page">
                <div class="stats-grid" id="overallStats">
                <div class="stat-card">
                    <h3>10</h3>
                    <p>إجمالي المشاركين</p>
                </div>
                <div class="stat-card">
                    <h3>18,343.6</h3>
                    <p>إجمالي الأفكار المحققة</p>
                </div>
                <div class="stat-card">
                    <h3>1834.4</h3>
                    <p>متوسط الأفكار لكل مشارك</p>
                </div>
                <div class="stat-card">
                    <h3>1</h3>
                    <p>عدد المواسم</p>
                </div>
            </div>
                
                <div class="card">
                    <h2><i class="fas fa-chart-line"></i> مقارنة المواسم</h2>
                    <div class="chart-container">
                        <canvas id="seasonsChart" style="box-sizing: border-box; display: block; height: 0px; width: 0px;" width="0" height="0"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Global variables
        let allData = [];
        let currentSeason = null;
        let charts = {};
        
        // Google Sheets CSV URL - Replace with your actual URL
        const SHEETS_URL = 'https://docs.google.com/spreadsheets/d/1_R9eYLil1B0krbta74AeYJNiOggp4aWRjO0Yr7_lc7Y/edit?gid=773724470#gid=773724470/export?format=csv';
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setInterval(loadData, 5 * 60 * 1000); // Update every 5 minutes
        });

        // Load data from Google Sheets
        async function loadData() {
            try {
                // For demo purposes, using sample data
                // In production, replace with actual fetch from SHEETS_URL
                const sampleData = generateSampleData();
                allData = sampleData;
                currentSeason = getCurrentSeason();
                
                updateCurrentResults();
                updateCountdown();
                updateExpelled();
                updateRecords();
                updateOverallStats();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        // Generate sample data for demo
        function generateSampleData() {
            const participants = [
                'أحمد محمد', 'فاطمة علي', 'محمد حسن', 'عائشة أحمد', 'خالد الصالح',
                'نورا الزهراني', 'عبدالله الحربي', 'مريم الشمري', 'سعد العتيبي', 'هدى القحطاني'
            ];
            
            const data = [];
            const today = new Date();
            
            for (let i = 0; i < 30; i++) {
                const date = new Date(today - (i * 24 * 60 * 60 * 1000));
                participants.forEach((name, index) => {
                    if (Math.random() > 0.3) { // 70% chance of reading
                        const minutes = Math.floor(Math.random() * 120) + 10;
                        const ideas = calculateIdeas(minutes);
                        const additionalIdeas = Math.random() > 0.8 ? 60 : 0; // Occasional bonus
                        
                        data.push({
                            timestamp: date.toISOString(),
                            date: formatDate(date),
                            season: 'محرم 1446',
                            email: `${name.replace(' ', '.')}@example.com`,
                            name: name,
                            timeCompleted: formatTime(minutes),
                            minutePoints: minutes,
                            additionalIdeas: additionalIdeas,
                            additionalPoints: additionalIdeas,
                            totalIdeas: ideas + additionalIdeas
                        });
                    }
                });
            }
            
            return data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }

        // Calculate ideas based on reading time with multipliers
        function calculateIdeas(minutes) {
            let ideas = 0;
            
            if (minutes <= 15) {
                ideas = minutes;
            } else if (minutes <= 30) {
                ideas = 15 + ((minutes - 15) * 1.15);
            } else {
                ideas = 15 + (15 * 1.15) + ((minutes - 30) * 1.2);
            }
            
            return Math.round(ideas * 100) / 100;
        }

        // Format time from minutes to H:M:S
        function formatTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours}:${mins}:00`;
        }

        // Format date
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        // Get current season
        function getCurrentSeason() {
            return 'محرم 1446';
        }

        // Show specific page
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected page and activate button
            document.getElementById(pageId).classList.add('active');
            event.target.classList.add('active');
        }

        // Update current results
        function updateCurrentResults() {
            const seasonData = allData.filter(d => d.season === currentSeason);
            const participants = getParticipantsStats(seasonData);
            
            // Ideas Chart
            updateIdeasChart(participants);
            
            // Streak Chart
            updateStreakChart(participants);
        }

        // Get participants statistics
        function getParticipantsStats(data) {
            const stats = {};
            
            data.forEach(entry => {
                if (!stats[entry.name]) {
                    stats[entry.name] = {
                        name: entry.name,
                        totalIdeas: 0,
                        totalMinutes: 0,
                        streak: 0,
                        lastReadingDate: null,
                        readingDays: new Set()
                    };
                }
                
                stats[entry.name].totalIdeas += entry.totalIdeas || 0;
                stats[entry.name].totalMinutes += entry.minutePoints || 0;
                stats[entry.name].readingDays.add(entry.date);
                
                if (!stats[entry.name].lastReadingDate || new Date(entry.date) > new Date(stats[entry.name].lastReadingDate)) {
                    stats[entry.name].lastReadingDate = entry.date;
                }
            });
            
            // Calculate streaks
            Object.keys(stats).forEach(name => {
                stats[name].streak = calculateStreak(stats[name].readingDays);
            });
            
            return Object.values(stats);
        }

        // Calculate reading streak
        function calculateStreak(readingDays) {
            const dates = Array.from(readingDays).sort().reverse();
            let streak = 0;
            const today = new Date().toISOString().split('T')[0];
            
            for (let i = 0; i < dates.length; i++) {
                const currentDate = new Date(dates[i]);
                const expectedDate = new Date();
                expectedDate.setDate(expectedDate.getDate() - i);
                
                if (dates[i] === expectedDate.toISOString().split('T')[0]) {
                    streak++;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        // Update Ideas Chart
        function updateIdeasChart(participants) {
            const ctx = document.getElementById('ideasChart').getContext('2d');
            const sortedParticipants = participants.sort((a, b) => b.totalIdeas - a.totalIdeas).slice(0, 10);
            
            if (charts.ideas) {
                charts.ideas.destroy();
            }
            
            charts.ideas = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedParticipants.map(p => p.name),
                    datasets: [{
                        label: 'إجمالي الأفكار',
                        data: sortedParticipants.map(p => p.totalIdeas),
                        backgroundColor: 'rgba(104, 121, 227, 0.8)',
                        borderColor: 'rgba(104, 121, 227, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                font: {
                                    family: 'Cairo',
                                    size: 14
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    family: 'Cairo'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    family: 'Cairo'
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update Streak Chart
        function updateStreakChart(participants) {
            const ctx = document.getElementById('streakChart').getContext('2d');
            const sortedParticipants = participants.sort((a, b) => b.streak - a.streak).slice(0, 10);
            
            if (charts.streak) {
                charts.streak.destroy();
            }
            
            charts.streak = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedParticipants.map(p => p.name),
                    datasets: [{
                        label: 'الأيام المتتالية',
                        data: sortedParticipants.map(p => p.streak),
                        backgroundColor: 'rgba(117, 79, 167, 0.8)',
                        borderColor: 'rgba(117, 79, 167, 1)',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                font: {
                                    family: 'Cairo',
                                    size: 14
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    family: 'Cairo'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    family: 'Cairo'
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update countdown table
        function updateCountdown() {
            const seasonData = allData.filter(d => d.season === currentSeason);
            const participants = getParticipantsStats(seasonData);
            const tbody = document.getElementById('countdownBody');
            
            // Calculate days remaining for each participant
            const countdownData = participants.map(p => {
                const daysRemaining = Math.floor(p.totalIdeas / 10);
                return {
                    ...p,
                    daysRemaining: Math.max(0, daysRemaining),
                    status: daysRemaining > 7 ? 'safe' : daysRemaining > 3 ? 'warning' : 'danger'
                };
            }).sort((a, b) => a.daysRemaining - b.daysRemaining);
            
            tbody.innerHTML = '';
            countdownData.forEach((participant, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><span class="rank-badge ${index < 3 ? 'rank-' + (index + 1) : 'rank-other'}">${index + 1}</span></td>
                    <td>${participant.name}</td>
                    <td>${participant.totalIdeas.toFixed(1)}</td>
                    <td>
                        <div class="countdown ${participant.status}">
                            <i class="fas fa-clock"></i>
                            ${participant.daysRemaining} يوم
                        </div>
                    </td>
                    <td><span class="status-indicator status-${participant.status}">${getStatusText(participant.status)}</span></td>
                `;
            });
        }

        // Get status text
        function getStatusText(status) {
            const statusTexts = {
                safe: 'آمن',
                warning: 'تحذير',
                danger: 'خطر'
            };
            return statusTexts[status] || 'غير محدد';
        }

        // Update expelled participants
        function updateExpelled() {
            const seasonData = allData.filter(d => d.season === currentSeason);
            const participants = getParticipantsStats(seasonData);
            const content = document.getElementById('expelledContent');
            
            // Find participants eligible for expulsion
            const expelled = participants.filter(p => 
                p.totalIdeas <= 0 || (getCurrentWeek() >= 3 && p.totalIdeas < 100)
            ).map(p => ({
                ...p,
                reason: p.totalIdeas <= 0 ? 'وصول الأفكار للصفر' : 'عدم تحقيق 100 فكرة بنهاية الأسبوع الثالث',
                expulsionDate: new Date().toISOString().split('T')[0]
            }));
            
            if (expelled.length === 0) {
                content.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--success);">
                        <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>لا يوجد مشاركون مستحقون للطرد حالياً</h3>
                        <p>جميع المشاركين يحافظون على مستوى جيد من القراءة!</p>
                    </div>
                `;
            } else {
                content.innerHTML = `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>اسم المشارك</th>
                                    <th>الأفكار الحالية</th>
                                    <th>سبب الطرد</th>
                                    <th>تاريخ الاستحقاق</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${expelled.map(p => `
                                    <tr>
                                        <td>${p.name}</td>
                                        <td>${p.totalIdeas.toFixed(1)}</td>
                                        <td>${p.reason}</td>
                                        <td>${p.expulsionDate}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
        }

        // Get current week of the season
        function getCurrentWeek() {
            // Simplified calculation - in real implementation, calculate based on season start date
            return 2;
        }

        // Update records
        function updateRecords() {
            const seasonData = allData.filter(d => d.season === currentSeason);
            const participants = getParticipantsStats(seasonData);
            const grid = document.getElementById('recordsGrid');
            
            // Most reading in one day
            const dailyReading = {};
            seasonData.forEach(entry => {
                const key = `${entry.name}-${entry.date}`;
                if (!dailyReading[key]) {
                    dailyReading[key] = { 
                        name: entry.name, 
                        date: entry.date, 
                        ideas: 0 
                    };
                }
                dailyReading[key].ideas += entry.totalIdeas || 0;
            });
            
            const topDailyReading = Object.values(dailyReading)
                .sort((a, b) => b.ideas - a.ideas)
                .slice(0, 3);
            
            // Most consistent participants
            const topStreak = participants
                .sort((a, b) => b.streak - a.streak)
                .slice(0, 3);
            
            // Highest total ideas
            const topIdeas = participants
                .sort((a, b) => b.totalIdeas - a.totalIdeas)
                .slice(0, 3);
            
            grid.innerHTML = `
                <div class="record-card">
                    <h3><i class="fas fa-star"></i> أكثر قراءة في يوم واحد</h3>
                    ${topDailyReading.map((record, index) => `
                        <div class="record-item">
                            <span><span class="rank-badge ${index < 3 ? 'rank-' + (index + 1) : 'rank-other'}">${index + 1}</span> ${record.name}</span>
                            <span>${record.ideas.toFixed(1)} فكرة</span>
                        </div>
                    `).join('')}
                </div>
                
                <div class="record-card">
                    <h3><i class="fas fa-fire"></i> أكثر استمرارية</h3>
                    ${topStreak.map((record, index) => `
                        <div class="record-item">
                            <span><span class="rank-badge ${index < 3 ? 'rank-' + (index + 1) : 'rank-other'}">${index + 1}</span> ${record.name}</span>
                            <span>${record.streak} يوم متتالي</span>
                        </div>
                    `).join('')}
                </div>
                
                <div class="record-card">
                    <h3><i class="fas fa-trophy"></i> أعلى إجمالي أفكار</h3>
                    ${topIdeas.map((record, index) => `
                        <div class="record-item">
                            <span><span class="rank-badge ${index < 3 ? 'rank-' + (index + 1) : 'rank-other'}">${index + 1}</span> ${record.name}</span>
                            <span>${record.totalIdeas.toFixed(1)} فكرة</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Update overall statistics
        function updateOverallStats() {
            const seasons = [...new Set(allData.map(d => d.season))];
            const participants = [...new Set(allData.map(d => d.name))];
            const totalIdeas = allData.reduce((sum, d) => sum + (d.totalIdeas || 0), 0);
            const avgIdeas = totalIdeas / participants.length;
            
            const statsContainer = document.getElementById('overallStats');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <h3>${participants.length}</h3>
                    <p>إجمالي المشاركين</p>
                </div>
                <div class="stat-card">
                    <h3>${totalIdeas.toLocaleString('ar')}</h3>
                    <p>إجمالي الأفكار المحققة</p>
                </div>
                <div class="stat-card">
                    <h3>${avgIdeas.toFixed(1)}</h3>
                    <p>متوسط الأفكار لكل مشارك</p>
                </div>
                <div class="stat-card">
                    <h3>${seasons.length}</h3>
                    <p>عدد المواسم</p>
                </div>
            `;
            
            // Update seasons comparison chart
            updateSeasonsChart(seasons);
        }

        // Update seasons comparison chart
        function updateSeasonsChart(seasons) {
            const ctx = document.getElementById('seasonsChart').getContext('2d');
            
            const seasonStats = seasons.map(season => {
                const seasonData = allData.filter(d => d.season === season);
                const totalIdeas = seasonData.reduce((sum, d) => sum + (d.totalIdeas || 0), 0);
                const uniqueParticipants = new Set(seasonData.map(d => d.name)).size;
                
                return {
                    season,
                    totalIdeas,
                    participants: uniqueParticipants,
                    avgIdeas: totalIdeas / uniqueParticipants || 0
                };
            });
            
            if (charts.seasons) {
                charts.seasons.destroy();
            }
            
            charts.seasons = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: seasonStats.map(s => s.season),
                    datasets: [
                        {
                            label: 'إجمالي الأفكار',
                            data: seasonStats.map(s => s.totalIdeas),
                            backgroundColor: 'rgba(104, 121, 227, 0.8)',
                            borderColor: 'rgba(104, 121, 227, 1)',
                            borderWidth: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'عدد المشاركين',
                            data: seasonStats.map(s => s.participants),
                            backgroundColor: 'rgba(117, 79, 167, 0.8)',
                            borderColor: 'rgba(117, 79, 167, 1)',
                            borderWidth: 2,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            labels: {
                                font: {
                                    family: 'Cairo',
                                    size: 14
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                font: {
                                    family: 'Cairo'
                                }
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: {
                                font: {
                                    family: 'Cairo'
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: {
                                font: {
                                    family: 'Cairo'
                                }
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        // Utility functions
        function formatArabicDate(dateString) {
            const date = new Date(dateString);
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                weekday: 'long'
            };
            return date.toLocaleDateString('ar-SA', options);
        }

        function getTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) return 'أمس';
            if (diffDays === 0) return 'اليوم';
            if (diffDays <= 7) return `منذ ${diffDays} أيام`;
            if (diffDays <= 30) return `منذ ${Math.ceil(diffDays / 7)} أسابيع`;
            return `منذ ${Math.ceil(diffDays / 30)} شهور`;
        }

        // Add loading states
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            element.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>جاري تحميل البيانات...</p>
                </div>
            `;
        }

        // Add error handling
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--danger);">
                    <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <h3>حدث خطأ في تحميل البيانات</h3>
                    <p>${message}</p>
                    <button onclick="loadData()" class="nav-btn" style="margin-top: 1rem;">
                        <i class="fas fa-sync-alt"></i> إعادة المحاولة
                    </button>
                </div>
            `;
        }

        // Add data validation
        function validateData(data) {
            if (!Array.isArray(data)) {
                throw new Error('البيانات المستلمة غير صحيحة');
            }
            
            const requiredFields = ['name', 'season', 'minutePoints'];
            const invalidEntries = data.filter(entry => 
                !requiredFields.every(field => entry.hasOwnProperty(field))
            );
            
            if (invalidEntries.length > 0) {
                console.warn('بعض البيانات غير مكتملة:', invalidEntries);
            }
            
            return data.filter(entry => 
                requiredFields.every(field => entry.hasOwnProperty(field))
            );
        }

        // Add real-time updates notification
        function showUpdateNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--success);
                color: white;
                padding: 1rem 2rem;
                border-radius: 25px;
                box-shadow: var(--shadow);
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            notification.innerHTML = '<i class="fas fa-check"></i> تم تحديث البيانات بنجاح';
            
            document.body.appendChild(notification);
            setTimeout(() => notification.style.opacity = '1', 100);
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // Enhanced mobile responsiveness
        function handleMobileView() {
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                // Adjust chart heights for mobile
                document.querySelectorAll('.chart-container').forEach(container => {
                    container.style.height = '250px';
                });
                
                // Make tables horizontally scrollable
                document.querySelectorAll('.table-container').forEach(container => {
                    container.style.overflowX = 'auto';
                });
            }
        }

        // Add event listeners for responsive design
        window.addEventListener('resize', handleMobileView);
        window.addEventListener('orientationchange', () => {
            setTimeout(handleMobileView, 100);
        });

        // Initialize mobile view
        handleMobileView();

        // Add keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                const navButtons = Array.from(document.querySelectorAll('.nav-btn'));
                const activeButton = document.querySelector('.nav-btn.active');
                const currentIndex = navButtons.indexOf(activeButton);
                
                let newIndex;
                if (e.key === 'ArrowLeft') {
                    newIndex = currentIndex > 0 ? currentIndex - 1 : navButtons.length - 1;
                } else {
                    newIndex = currentIndex < navButtons.length - 1 ? currentIndex + 1 : 0;
                }
                
                navButtons[newIndex].click();
                e.preventDefault();
            }
        });

        // Add accessibility improvements
        document.querySelectorAll('.nav-btn').forEach((btn, index) => {
            btn.setAttribute('role', 'tab');
            btn.setAttribute('tabindex', index === 0 ? '0' : '-1');
        });

        // Add print styles
        const printStyles = `
            @media print {
                .nav, .header { display: none !important; }
                .page:not(.active) { display: block !important; }
                .card { break-inside: avoid; margin-bottom: 1rem; }
                .chart-container { height: 300px !important; }
                body { background: white !important; }
            }
        `;
        
        const styleSheet = document.createElement('style');
        styleSheet.textContent = printStyles;
        document.head.appendChild(styleSheet);
    </script>


</body></html>
